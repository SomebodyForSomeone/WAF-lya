# WAF-lya

**WAF-lya** — это легковесный Web Application Firewall (WAF), написанный на Go. Работает в режиме **Reverse Proxy**, обеспечивая фильтрацию входящего HTTP-трафика перед передачей его на целевой сервер.

Основная особенность — **Stateful-анализ**, который отслеживает контекст сессии пользователя для выявления аномалий поведения (например, перебора ID ресурсов или сканирования), а не просто блокирует по статическим правилам.

## Возможности

- **Rate Limiting (Token Bucket):** Ограничение частоты запросов с поддержкой "всплесков".
    
- **Stateful Context Analysis (Защита от BOLA):** Отслеживание количества уникальных ресурсов, к которым обращается пользователь за единицу времени. Эффективно против перебора ID (IDOR/BOLA) и сканирования.
    
- **Signature Analysis:** Фильтрация классических векторов атак (SQL Injection, XSS, Path Traversal) с предварительной нормализацией запроса (удаление комментариев, декодирование, приведение регистра).
    
- **Dynamic Throttling:** При повторных нарушениях время блокировки (бана) увеличивается экспоненциально (множитель настраивается).
    
- **In-Memory Storage:** Высокая скорость обработки за счет хранения состояний в оперативной памяти.

## Установка и запуск

### Требования

- Go 1.25+

### Запуск

1. **Клонируйте репозиторий:**
   ```bash
   git clone https://github.com/SomebodyForSomeone/WAF-lya/tree/main
   cd WAF-lya
   ```
   
2. **Установите зависимости:**
   ```bash
   go mod tidy
   ```
   
3. **Запустите WAF:**
```bash
go run ./cmd
```
По умолчанию WAF запускается на порту `:8000` и проксирует запросы на `http://localhost:8081`.

**Изменение портов и адресов:**
- Через `waf_config.json`
- Через аргумент командной строки: `go run ./cmd waf_config_alt.json`
- Через переменную окружения: `WAF_CONFIG=waf_config_alt.json go run ./cmd`

## Конфигурация

Настройка параметров защиты производится в файле ```waf_config.json```. Изменения требуют перезапуска приложения.

Пример конфигурации:

```json
{
  "waf_port": ":8000",           // Порт WAF (опционально, по умолчанию :8000)
  "server_address": "http://localhost:8081", // Адрес целевого сервера (опционально)
  
  "middleware_chain": [   // Настройка порядка Middleware в цепочке программы 
    "context",
    "rate_limit",
    "signature"
  ],
  "rate_limit": {
    "limit": 5,           // Запросов в секунду (RPS)
    "burst": 20,          // Максимальный всплеск
    "ban_seconds": 30,    // Время первого бана
    "multiplier": 2.0,    // Множитель времени бана при повторном нарушении
    "violation_reset_hours": 24 // Таймаут сброса множителя блокировки
  },
  "context": {
    "window_seconds": 60, // Окно анализа поведения
    "threshold": 20,      // Лимит уникальных ресурсов (ID) за окно
    "ban_seconds": 300,   // Время бана за подозрение на BOLA
    "multiplier": 2.0
  },
  "signature": {
    "log_matches": true   // Логирование совпадений сигнатур в консоль
  }
}

## Принцип работы

WAF выстраивает цепочку модулей защиты перед запросом к бэкенду:

1. **Context Middleware:** Проверяет сессию на аномалии (например, доступ к `/api/user/1`, затем `/api/user/2`...). Если порог уникальных ресурсов превышен — IP блокируется.
    
2. **Rate Limit Middleware:** Проверяет токены в "корзине". Если лимит исчерпан — IP временно блокируется (429 Too Many Requests).
    
3. **Signature Middleware:** Нормализует URL и тело запроса, проверяет по регулярным выражениям (SQLi, XSS). При совпадении возвращает 403 Forbidden.
    
4. **Reverse Proxy:** Если все проверки пройдены, запрос передается на целевой сервис.
    

## Примечание

На данный момент состояние хранится в `sync.Map` в оперативной памяти. При перезапуске приложения данные о текущих сессиях и блокировках сбрасываются.